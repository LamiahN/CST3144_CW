<!DOCTYPE html>
<html lang = "en">
    <head>
        <title>Index</title>
        <meta charset="utf-8">

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
        <script src="https://cdn.jsdelivr.net/npm/vue@2.7.16/dist/vue.js"></script>

        <script src="products.js"></script>
        <link rel="stylesheet" href="styles.css">

        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=DynaPuff:wght@400..700&display=swap" rel="stylesheet">
    </head>

    <body>
        <!-- The element where Vue will mount -->
        <div id="app">
            <!-- Header -->
            <header>
                <h1 v-text = "sitename"></h1>
                <!-- Search control -->
                <div class="controls">
                    <input class="input" type="search"
                        placeholder="Search activities"
                        v-model.trim="searchQuery" />
                </div>
                <button @click="showCheckout" v-if="canCheckout()" class="btn-pill">
                    <span class="fas fa-shopping-cart"></span> Checkout ({{ cartItemCount }})
                </button>
                <button disabled v-else class="btn-pill" disabled>
                    <span class="fas fa-shopping-cart"></span> Checkout (0)
                </button>
            </header>

            <!-- Main -->
            <main>
                <!-- Displaying Lessons -->
                <div class="card-body" v-if="showProduct">

                    <!-- Message for no activities found when searching -->
                    <div class="empty" v-if="filteredProducts.length === 0">
                        <strong>No activities found!</strong>
                        <div v-if="searchQuery">for "{{ searchQuery }}".</div>
                    </div>

                    <!-- Sorting controls -->
                    <div class="sorting-controls">
                        <label for="sortKey">Sort by:</label>
                        <select id="sortKey" v-model="sortKey">
                            <option value="title">Title</option>
                            <option value="category">Category</option>
                            <option value="price">Price</option>
                            <option value="rating">Rating</option>
                            <option value="location">Location</option>
                            <option value="availableInventory">Available Spaces</option>
                        </select>

                        <label for="sortDirection">Direction:</label>
                        <select id="sortDirection" v-model="sortDirection">
                            <option value="asc">Ascending</option>
                            <option value="desc">Descending</option>
                        </select>
                    </div>
                    
                    <!-- Activities 4 per grid -->
                    <div class="card-layout" v-else>
                        <div v-for="product in sortedProducts" :key="product.id" class="card">
                            <figure class="icon">
                                <img :src="product.image" alt="">
                            </figure>
                            <div class="card-content">
                                <h2 v-text="product.title"></h2>
                                <div>
                                    <span v-for="n in product.rating" class="fa fa-star checked"></span>
                                    <span v-for="n in 5 - product.rating" class="fa fa-star-o"></span>
                                </div>
                                <p v-html="product.description"></p>
                                <p>Location: {{product.location}}</p>
                                <p>Price: {{Number(product.price).toFixed(2)}}</p>
                                <p>Available spaces: {{ product.availableInventory - cartCount(product.id) }}</p>

                                <button @click="addToCart(product)" v-if="canAddToCart(product)" class="btn-pill">
                                    Add to Cart
                                </button>
                                <button disabled v-else class="btn-pill" disabled> Sold Out</button>
                            
                                <span v-if="product.availableInventory === cartCount(product.id)">All out!</span>
                                <span v-else-if="product.availableInventory - cartCount(product.id) < 5">
                                    Only {{product.availableInventory - cartCount(product.id)}} left!
                                </span>
                                <span v-else style="margin-left: 0.5rem;">Buy now!</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Displaying Checkout Section -->
                <div v-else>
                    <h2>Checkout</h2>

                    <p v-if="cart.length === 0">Your cart is empty.</p>
                    
                    <p>
                        <strong>First Name:</strong>
                        <!-- This input field is bound to 'firstName' in the 'order' object -->
                         <input v-model.trim="order.firstName"/>
                    </p>
                    <p>
                        <strong>Last Name:</strong>
                        <!-- This input field is bound to 'lastName' in the 'order' object -->
                         <input v-model.trim="order.lastName"/>
                    </p>
                    <p>
                        <strong>Phone Number:</strong>
                        <!-- This input field is bound to 'phoneNumber' in the 'order' object -->
                         <input v-model="order.phoneNumber"/>
                    </p>
                    <button v-on:click="submitForm">Place Order</button>

                    <h2>Order Information</h2>
                    <p>First Name: {{order.firstName}}</p>
                    <p>Last Name: {{order.lastName}}</p>
                    <p>Phone Number: {{order.phoneNumber}}</p>

                    <ul>
                        <li v-for="item in cart">Activity: {{ item.title }} - AED {{ item.price }}</li>
                    </ul>
                    <h3>Total: AED {{ cartTotal }}</h3>
                    <button v-on:click="clearCart" v-if="cart.length > 0">Clear Cart</button>
                </div>

                <!-- Footer -->
                <footer class="footer-bar">
                    <img src="Images/footer-pencils.png" alt="Decorative footer pencils"/>
                </footer>
            </main>
        </div>

        <!-- Script -->
        <script type="text/javascript">
            var webstore = new Vue ({ 
                el:'#app',
                data:{
                    sortKey: 'price',
                    sortDirection: 'asc',
                    showProduct: true,
                    sitename: 'After School Activities',
                    order:{
                        firstName: '',
                        lastName: '',
                        phoneNumber: '',
                    },
                    products: products,
                    cart:[], // array to store items in shopping cart  
                    searchQuery: ''  
                },
                methods: {
                    addToCart(product) {
                        this.cart.push(product);
                        product.availableInventory--;
                    },                     
                    /*addToCart(product) {
                        if (!this.canAddToCart(product)) return;
                        this.cart.push(product.id);
                    },*/
                    showCheckout() {
                        // console.log(this.showProduct);
                        this.showProduct = this.showProduct ? false : true;
                    },
                    submitForm() {
                        alert('Order submitted!')
                    },
                    canAddToCart(product) {
                        return product.availableInventory > this.cartCount(product.id);
                    },
                    canCheckout() {
                        return this.cart.length > 0;
                    },
                    cartCount(id) {
                        let count = 0;
                        for (let i = 0; i < this.cart.length; i++) {
                            if (this.cart[i] === id) {
                                count++;
                            }
                        }
                        return count;
                    },
                    clearCart() {
                        this.cart.forEach(item => {
                            const product = this.products.find(p => p.id === item.id);
                            if (product) {
                                product.availableInventory++;
                            }
                        });
                        this.cart = [];
                    }
                },
                computed: { // cannot take any parameters
                    cartItemCount: function() {
                        return this.cart.length || ""; // returns the number of items in the cart
                    },
                    sortedProducts: function() {
                        let productsArray = this.filteredProducts.slice(); // creates a copy of the filtered products array
                        let direction = this.sortDirection === 'desc' ? -1 : 1;

                        productsArray.sort((a, b) => {
                            let valueA, valueB;
                            
                            if(this.sortKey === 'title') {
                                valueA = a.title.toLowerCase();
                                valueB = b.title.toLowerCase();
                            } 
                            else if(this.sortKey === 'category') {
                                valueA = a.title.toLowerCase();
                                valueB = b.title.toLowerCase();
                            } 
                            else if(this.sortKey === 'price') {
                                valueA = a.price;
                                valueB = b.price;
                            } 
                            else if(this.sortKey === 'rating') {
                                valueA = a.rating;
                                valueB = b.rating;
                            }
                            else if(this.sortKey === 'location') {
                                valueA = a.location.toLowerCase();
                                valueB = b.location.toLowerCase();
                            } else if(this.sortKey === 'availableInventory') {
                                valueA = a.availableInventory;
                                valueB = b.availableInventory;
                            }
                            else {
                                valueA = 0;
                                valueB = 0;
                            }

                            if (valueA < valueB) return -1 * direction;
                            if (valueA > valueB) return 1 * direction;
                            return 0;
                
                        });
                        return productsArray; // returns a sorted array of products
                        
                    },
                    /*sortedProducts: function() {
                        let productsArray = this.filteredProducts.slice(); // creates a copy of the filtered products array

                        function compare(a, b) {
                            if (a.price > b.price) return 1;
                            if (a.price < b.price) return -1;
                            return 0;
                        }
                        return productsArray.sort(compare); // returns a sorted array of products by price
                    },*/
                    filteredProducts: function () {
                        const q = this.searchQuery.trim().toLowerCase();
                        if (!q) return this.products;
                        return this.products.filter(p => {
                            const title = String(p.title || '').toLowerCase();
                            const desc  = String(p.description || '').toLowerCase();
                            const cat   = String(p.category || '').toLowerCase();
                            return title.includes(q) || desc.includes(q) || cat.includes(q);
                        });
                    },
                    cartTotal(){
                        return this.cart.reduce((total, item) => total + item.price, 0).toFixed(2);
                    },

                }
            });
        </script>
    </body>
</html>