<!DOCTYPE html>
<html lang = "en">
    <head>
        <title>Index</title>
        <meta charset="utf-8">

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
        <script src="https://cdn.jsdelivr.net/npm/vue@2.7.16/dist/vue.js"></script>

        <!-- <script src="products.js"></script> --> <!-- removed as products are now fetched from backend -->
        <link rel="stylesheet" href="styles.css">

        <!-- links for google fonts s-->
        <link rel="preconnect" href="https://fonts.googleapis.com"> 
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=DynaPuff:wght@400..700&display=swap" rel="stylesheet">
    </head>

    <body>
        <!-- The element where Vue will mount -->
        <div id="app">
            <!-- Header -->
            <header>
                <h1 v-text = "sitename" style="margin-left: 2rem;"></h1>
                <!-- Search control -->
                <div class="controls">
                    <input class="input" type="search"
                        placeholder="Search activities"
                        v-model.trim="searchQuery" />    
                </div>
                <!-- Checkout button -->
                <button @click="showCheckout" v-if="canCheckout()" class="btn-pill">
                    <span class="fas fa-shopping-cart"></span> Checkout ({{ cartItemCount }})
                </button>
                <button disabled v-else class="btn-pill" disabled>
                    <span class="fas fa-shopping-cart"></span> Checkout (0)
                </button>
            </header>

            <!-- Main -->
            <main>
                <!-- Displaying Lessons -->
                <div class="card-body" v-if="showProduct">

                    <!-- Sorting controls -->
                    <div class="sorting-bar">
                        <label for="sortKey" class="sorting-label">Sort by: </label>
                        <select id="sortKey" v-model="sortKey">
                            <option value="title">Title</option>
                            <option value="price">Price</option>
                            <option value="rating">Rating</option>
                            <option value="location">Location</option>
                            <option value="availableInventory">Available Spaces</option>
                        </select>

                        <label for="sortDirection" class="sorting-label">Direction: </label>
                        <select id="sortDirection" v-model="sortDirection">
                            <option value="asc">Ascending</option>
                            <option value="desc">Descending</option>
                        </select>
                    </div>

                    <!-- Message for no activities found when searching -->
                    <div class="empty" v-if="filteredProducts.length === 0">
                        <strong>No activities found!</strong>
                        <div v-if="searchQuery">for "{{ searchQuery }}".</div>
                    </div>
                    
                    <!-- Displaying Activities -->
                    <div class="card-layout" >
                        <div v-for="product in sortedProducts" :key="product.id" class="card">
                            <figure class="icon">
                                <img :src="'/static/Images/' + product.image" alt="">
                            </figure>
                            <div class="card-content">
                                <h2 v-text="product.title"></h2>
                                <div>
                                    <span v-for="n in product.rating" class="fa fa-star checked"></span>
                                    <span v-for="n in 5 - product.rating" class="fa fa-star-o"></span>
                                </div>
                                <p v-html="product.description"></p>
                                <p>Location: {{product.location}}</p>
                                <p>Price: {{Number(product.price).toFixed(2)}}</p>
                                <p>Available spaces: {{ product.availableInventory}}</p>

                                <button @click="addToCart(product)" v-if="canAddToCart(product)" class="btn-pill">
                                    Add to Cart
                                </button>
                                <button disabled v-else class="btn-pill" disabled> Sold Out</button>
                            
                                <span v-if="product.availableInventory === cartCount(product.id)">All out!</span>
                                <span v-else-if="product.availableInventory - cartCount(product.id) < 5">
                                    Only {{product.availableInventory - cartCount(product.id)}} left!
                                </span>
                                <span v-else style="margin-left: 0.5rem;">Buy now!</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Displaying Checkout Section -->
                <div v-else>
                    <div class="checkout-card">

                        <h2 style="text-align: center; font-size: 2rem; font-weight: 900; color: #4b56db; margin: 4px 0 18px;">Checkout</h2>

                        <!-- Displaying Cart Items -->
                        <ul class="cart-list">
                            <li v-for="(item, index) in cart" :key="index" class="cart-item">
                                {{ item.title }} - AED {{ Number(item.price).toFixed(2) }}
                                <button class="remove-item" @click="removeFromCart(index)">Remove</button>
                            </li>
                        </ul>
                        
                        <!-- Displaying Total Price -->
                        <h2 style="text-align: right; font-size: 1.25rem; color: #4b56db; font-weight: 900; margin: 10px 0 18px;">Total: AED {{ cartTotal }}</h2>

                        <!-- User Information Form -->
                        <input v-model="order.firstName" class="checkout-input" placeholder="First Name"/>
                        <p v-if="!validFirstName && order.firstName" class="validityNote">Please enter a valid first name.</p>
                        
                        <input v-model="order.lastName" class="checkout-input" placeholder="Last Name"/>
                        <p v-if="!validLastName && order.lastName" class="validityNote">Please enter a valid last name.</p>
                        
                        <input v-model="order.phoneNumber" class="checkout-input" placeholder="Phone Number"/>
                        <p v-if="!validPhoneNumber && order.phoneNumber" class="validityNote">Please enter a valid phone number.</p>
    
                        <!-- Displaying user details from inputs, dynamically -->
                        <h2>Order Information</h2>
                        <p>First Name: {{order.firstName}}</p>
                        <p>Last Name: {{order.lastName}}</p>
                        <p>Phone Number: {{order.phoneNumber}}</p>

                        <!-- Submit and Back Buttons -->
                        <button class="checkout-primary-btns" :disabled="!validOrder" v-on:click="submitForm">Checkout</button>
                        <button class="checkout-primary-btns" @click="showProduct = true" class="back-btn">Back</button>
                    </div>
                </div>

                <!-- Footer -->
                <footer class="footer-bar">
                    <img src="Images/footer-pencils.png" alt="Decorative footer pencils"/>
                </footer>
            </main>
        </div>

        <!-- Script -->
        <script type="text/javascript">
            var webstore = new Vue ({ 
                el:'#app',
                data:{
                    sortKey: 'price',
                    sortDirection: 'asc',
                    showProduct: true,
                    sitename: 'After School Activities',
                    order:{
                        firstName: '',
                        lastName: '',
                        phoneNumber: '',
                    },
                    //products: products,
                    products: [], // initially empty, to be fetched from backend
                    cart:[], // array to store items in shopping cart  
                    searchQuery: ''  
                },
                methods: {
                    addToCart(product) {
                        this.cart.push(product);
                        product.availableInventory--;
                    },                     
                    showCheckout() {
                        // console.log(this.showProduct);
                        this.showProduct = this.showProduct ? false : true;
                    },
                    // can we add one more of this product? (based on spaces left)
                    canAddToCart(product) { 
                        return product.availableInventory > this.cartCount(product.id);
                    },

                    // can we go to checkout? (cart must not be empty)
                    canCheckout() {
                        return this.cart.length > 0;
                    },

                    // how many of a specific product are in the cart
                    cartCount(id) { 
                        let count = 0;
                        for (let i = 0; i < this.cart.length; i++) {
                            if (this.cart[i] === id) {
                                count++;
                            }
                        }
                        return count;
                    },

                    // clear cart (used if you ever want a "clear cart" button)
                    clearCart() {
                        this.cart = [];
                    },
                    
                    /*submitForm() {
                        // array of order items with lessonID, title, quantity
                        const orderItems = [];

                        this.cart.forEach(item => {
                            // using mongo _id if present otherwise default to item.id
                            const lessonID = item._id || item.id;

                            const existing = orderItems.find(i => i.lessonID === lessonID);
                            if (existing) {
                                existing.quantity += 1;
                            } else {
                                orderItems.push({
                                    lessonID: lessonID,
                                    title: item.title,
                                    quantity: 1
                                });
                            }
                        });

                        // order object to matche the backend
                        const orderData = {
                            name: this.order.firstName + ' ' + this.order.lastName,
                            phoneNumber: this.order.phoneNumber,
                            orderItems: orderItems,
                            numberOfSpace: this.cart.length // total items in cart
                        };

                        // send POST request to backend
                        fetch('http://localhost:3000/orders', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(orderData)
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Failed to submit order');
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log('Order saved:', data);
                            alert('Order submitted successfully!');

                            // cleanup after successful order
                            this.cart = [];
                            this.order.firstName = '';
                            this.order.lastName = '';
                            this.order.phoneNumber = '';
                            this.showProduct = true; // back to activities page
                        })
                        .catch(error => {
                            console.error('Error submitting order:', error);
                            alert('There was a problem submitting your order. Please try again.');
                        });
                    },*/
                    
                    // check if product can be added to cart based on available inventory
                    /*canAddToCart(product) {
                        return product.availableInventory > this.cartCount(product.id);
                    },
                    
                    // check if checkout is possible based on cart contents
                    canCheckout() {
                        return this.cart.length > 0;
                    },
                    // count how many of a specific product is in the cart
                    cartCount(id) {
                        let count = 0;
                        for (let i = 0; i < this.cart.length; i++) {
                            if (this.cart[i] === id) {
                                count++;
                            }
                        }
                        return count;
                    },
                    // clear the cart and restore product inventories
                    clearCart() {
                        this.cart.forEach(item => {
                            const product = this.products.find(p => p.id === item.id);
                            if (product) {
                                product.availableInventory++;
                            }
                        });
                        this.cart = [];
                    },*/
                    removeFromCart(index) { // remove item from cart based on index
                        const item = this.cart[index];
                        if (!item) return;

                        // give the seat back to the product
                        const p = this.products.find(p => // find the product in products array
                            (p.id !== undefined && p.id === item.id) || p.title === item.title // in case id is missing
                        );
                        if (p) p.availableInventory += 1; // increase available inventory

                        // remove from cart UI array
                        this.cart.splice(index, 1);
                    },
                    // ----------- New methods for backend integration -----------
                    // Grouping cart items into lessonID + title + quantity 
                    buildOrderItems() {
                        const orderItems = [];

                        this.cart.forEach(item => {
                            const lessonID = item._id || item.id;

                            const existing = orderItems.find(i => i.lessonID === lessonID);
                            if (existing) {
                                existing.quantity += 1;
                            } else {
                                orderItems.push({
                                    lessonID: lessonID,
                                    title: item.title,
                                    quantity: 1
                                });
                            }
                        });

                        return orderItems;
                    },
                    // Saving order in "orders" collection (POST /orders)  ✅
                    async saveOrder(orderItems) {
                        const orderData = {
                            name: this.order.firstName + ' ' + this.order.lastName,
                            phoneNumber: this.order.phoneNumber,
                            orderItems: orderItems,
                            numberOfSpace: this.cart.length
                        };

                        const response = await fetch('https://cst3144-cw1-backend-s0fc.onrender.com/orders', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(orderData)
                        });

                        if (!response.ok) {
                            throw new Error('Failed to submit order');
                        }

                        return response.json(); // contains message + orderId
                    },

                    // Update availableInventory for each lesson in cart (PUT /lessons/:id) ✅
                    async updateLessonInventoryOnServer() {
                        const uniqueLessonIds = [...new Set(
                            this.cart.map(item => item._id || item.id)
                        )];

                        for (const lessonID of uniqueLessonIds) {
                            const product = this.products.find(
                                p => (p._id || p.id) === lessonID
                            );
                            if (!product) continue;

                            const putRes = await fetch(`https://cst3144-cw1-backend-s0fc.onrender.com/lessons/${lessonID}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ availableInventory: product.availableInventory })
                            });

                            if (!putRes.ok) {
                                console.error('Failed to update inventory for lesson', lessonID);
                            }
                        }
                    },

                    // Re-fetch lessons from backend (GET /lessons)
                    async refreshLessons() {
                        const res = await fetch('https://cst3144-cw1-backend-s0fc.onrender.com/lessons');
                        if (res.ok) {
                            this.products = await res.json();
                        }
                    },

                    // Clear form + cart and go back to activities view
                    resetOrderState() {
                        this.cart = [];
                        this.order.firstName = '';
                        this.order.lastName = '';
                        this.order.phoneNumber = '';
                        this.showProduct = true;
                    },

                    // Orchestrator method for form submission
                    async submitForm() {
                        try {
                            const orderItems = this.buildOrderItems();
                            const data = await this.saveOrder(orderItems);
                            console.log('Order saved:', data);

                            await this.updateLessonInventoryOnServer();
                            await this.refreshLessons();

                            alert('Order submitted successfully!');
                            this.resetOrderState();
                        } catch (error) {
                            console.error('Error submitting order:', error);
                            alert('There was a problem submitting your order. Please try again.');
                        }
                    },
                    // Fetch search results from backend
                    fetchSearchResults(query) {
                        if (!query) { 
                            // If empty search, reload all lessons
                            fetch("https://cst3144-cw1-backend-s0fc.onrender.com/lessons")
                                .then(res => res.json())
                                .then(data => this.products = data);
                            return;
                        }

                        fetch(`https://cst3144-cw1-backend-s0fc.onrender.com/search?query=${encodeURIComponent(query)}`) // encodeURIComponent to handle special characters
                            .then(res => res.json())
                            .then(data => {
                                this.products = data;
                            })
                            .catch(err => console.error(err));
                    }
                },
                mounted() {
                    // Fetch lessons from backend when the app loads (GET /lessons)
                    fetch('https://cst3144-cw1-backend-s0fc.onrender.com/lessons')
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Failed to load lessons');
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log('Lessons from backend:', data);
                            this.products = data;
                        })
                        .catch(error => {
                            console.error('Error fetching lessons:', error);
                        });
                },
                computed: { // cannot take any parameters. performs calculations based on data properties
                    cartItemCount: function() {
                        return this.cart.length || ""; // returns the number of items in the cart
                    },
                    sortedProducts: function() {
                        let productsArray = this.filteredProducts.slice(); // creates a copy of the filtered products array
                        let direction = this.sortDirection === 'desc' ? -1 : 1;

                        // helper function to calculate spaces left
                        const spacesLeft = (product) => {
                            return product.availableInventory - this.cartCount(product.id);
                        };

                        productsArray.sort((a, b) => {
                            let valueA, valueB;
                            
                            if(this.sortKey === 'title') {
                                valueA = a.title.toLowerCase();
                                valueB = b.title.toLowerCase();
                            } 
                            else if(this.sortKey === 'price') {
                                valueA = a.price;
                                valueB = b.price;
                            } 
                            else if(this.sortKey === 'rating') {
                                valueA = a.rating;
                                valueB = b.rating;
                            }
                            else if(this.sortKey === 'location') {
                                valueA = a.location.toLowerCase();
                                valueB = b.location.toLowerCase();
                            } 
                            else if(this.sortKey === 'availableInventory') {
                                valueA = a.availableInventory;
                                valueB = b.availableInventory;
                            }
                            else {
                                valueA = 0;
                                valueB = 0;
                            }

                            if (valueA < valueB) return -1 * direction;
                            if (valueA > valueB) return 1 * direction;
                            return 0;
                
                        });
                        return productsArray; // returns a sorted array of products
                        
                    },
                    /*filteredProducts: function () { // old filter products based on search query but still used for local filtering
                        const q = this.searchQuery.trim().toLowerCase();
                        if (!q) return this.products;
                        return this.products.filter(p => {
                            const title = String(p.title || '').toLowerCase();
                            const desc  = String(p.description || '').toLowerCase();
                            const cat   = String(p.category || '').toLowerCase();
                            const loc = String(p.location || '').toLowerCase();
                            return title.includes(q) || desc.includes(q) || cat.includes(q) || loc.includes(q); 
                        });
                    },*/
                    filteredProducts() {
                        return this.products;  // products already filtered by backend
                    },
                    cartTotal(){
                        return this.cart.reduce((total, item) => total + item.price, 0).toFixed(2);
                    },
                    validFirstName() {
                        const nameRegex = /^[A-Za-z]{2,}$/;
                        return nameRegex.test(this.order.firstName);
                    },
                    validLastName() {
                        const nameRegex = /^[A-Za-z]{2,}$/;
                        return nameRegex.test(this.order.lastName);
                    },
                    validPhoneNumber() {
                        const phoneRegex = /^\+?[0-9]{7,15}$/;
                        return phoneRegex.test(this.order.phoneNumber);
                    },
                    validOrder() {
                        return this.validFirstName && this.validLastName && this.validPhoneNumber;
                    }
                },
                watch: { // watcher to trigger backend search when user types
                    searchQuery(newValue) {
                        this.fetchSearchResults(newValue);
                    }
                }
            });
        </script>
    </body>
</html>